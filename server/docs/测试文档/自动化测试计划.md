# 团队报名系统服务端自动化测试计划

## 概述

本文档详细说明团队报名系统服务端的自动化测试策略，作为项目结构改造后的下一阶段工作。测试计划包括单元测试、集成测试和端到端测试，目标是确保系统在重构后保持正确的功能，并为未来的开发提供安全网。

## 更新记录

**2023年4月6日更新**:
- 补充了依赖注入容器相关测试策略
- 添加了 BaseService 单例模式测试方法
- 新增了服务预热机制和初始化顺序测试计划
- 更新了集成测试中关于跨域服务依赖的处理方法

## 测试目标

1. **验证功能正确性**：确保所有业务功能在重构后仍然正常工作
2. **提高代码质量**：通过测试驱动开发提高代码的可维护性
3. **防止回归**：防止新功能或修复引入新的问题
4. **文档化行为**：测试作为系统行为的文档
5. **提高开发效率**：通过自动化测试减少手动测试时间

## 测试工具选择

### 单元测试
- **框架**：Jest
- **辅助工具**：Sinon (用于模拟和存根)
- **断言库**：Jest内置断言库

### 集成测试
- **框架**：Jest + Supertest
- **数据库**：MongoDB Memory Server (用于测试环境)

### 端到端测试
- **框架**：Cypress
- **API测试**：Postman/Newman

### 代码覆盖率工具
- **工具**：Istanbul.js (通过Jest集成)
- **目标覆盖率**：
  - 单元测试：>80%
  - 集成测试：>60%
  - 总覆盖率：>70%

## 测试策略

### 单元测试

单元测试将专注于测试各个领域的模型、服务和控制器，确保它们的独立功能正确。

#### 模型测试

针对领域模型中的业务规则和验证逻辑进行测试。

```javascript
// Registration模型测试示例
describe('Registration Model', () => {
  test('should validate required fields', () => {
    const registration = new Registration({});
    const result = registration.validate();
    expect(result.isValid).toBe(false);
    expect(result.errors).toContain('团队名称不能为空');
    expect(result.errors).toContain('领队信息不完整');
  });
  
  test('should add member if not exists', () => {
    const registration = new Registration({
      teamName: '测试团队',
      leader: { name: '张三', phone: '13800000000' },
      members: []
    });
    
    const newMember = { name: '李四', phone: '13900000000' };
    registration.addMember(newMember);
    
    expect(registration.members).toHaveLength(1);
    expect(registration.members[0]).toEqual(newMember);
  });
  
  test('should throw error when adding existing member', () => {
    const existingMember = { name: '李四', phone: '13900000000' };
    const registration = new Registration({
      teamName: '测试团队',
      leader: { name: '张三', phone: '13800000000' },
      members: [existingMember]
    });
    
    expect(() => {
      registration.addMember(existingMember);
    }).toThrow('成员已存在');
  });
});
```

#### 服务测试

测试服务层的业务逻辑，使用模拟对象替代外部依赖。

```javascript
// RegistrationService测试示例
describe('RegistrationService', () => {
  let registrationService;
  let mockRepository;
  
  beforeEach(() => {
    // 创建模拟仓储
    mockRepository = {
      save: jest.fn(),
      findByLeaderPhone: jest.fn()
    };
    
    // 创建服务实例，注入模拟仓储
    registrationService = new RegistrationService(mockRepository);
  });
  
  test('should create registration successfully', async () => {
    // 准备测试数据
    const registrationData = {
      teamName: '测试团队',
      leader: { name: '张三', phone: '13800000000' }
    };
    
    // 配置模拟行为
    mockRepository.findByLeaderPhone.mockResolvedValue(null);
    mockRepository.save.mockResolvedValue({ _id: '123', ...registrationData });
    
    // 执行测试
    const result = await registrationService.createRegistration(registrationData);
    
    // 验证结果
    expect(result._id).toBe('123');
    expect(result.teamName).toBe('测试团队');
    
    // 验证模拟对象的调用情况
    expect(mockRepository.findByLeaderPhone).toHaveBeenCalledWith('13800000000');
    expect(mockRepository.save).toHaveBeenCalled();
  });
  
  test('should throw error if leader phone already exists', async () => {
    // 准备测试数据
    const registrationData = {
      teamName: '测试团队',
      leader: { name: '张三', phone: '13800000000' }
    };
    
    // 配置模拟行为 - 返回已存在的记录
    mockRepository.findByLeaderPhone.mockResolvedValue({ _id: '456' });
    
    // 执行并验证异常
    await expect(
      registrationService.createRegistration(registrationData)
    ).rejects.toThrow('领队手机号已被注册');
    
    // 验证save没有被调用
    expect(mockRepository.save).not.toHaveBeenCalled();
  });
});
```

#### 控制器测试

测试控制器的请求处理逻辑，使用模拟服务和请求/响应对象。

```javascript
// teamController测试示例
describe('teamController', () => {
  let req, res;
  let mockTeamService;
  
  beforeEach(() => {
    // 模拟请求和响应对象
    req = { body: {} };
    res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn()
    };
    
    // 模拟服务
    mockTeamService = {
      createTeamLeader: jest.fn()
    };
    
    // 注入模拟服务
    jest.mock('../services/TeamService', () => mockTeamService);
  });
  
  test('should create team leader successfully', async () => {
    // 准备测试数据
    req.body = {
      name: '张三',
      phone: '13800000000',
      teamName: '测试团队'
    };
    
    // 配置模拟服务行为
    mockTeamService.createTeamLeader.mockResolvedValue({
      _id: '123',
      teamName: '测试团队',
      inviteCode: 'ABC123'
    });
    
    // 执行控制器方法
    await teamController.createTeamLeader(req, res);
    
    // 验证结果
    expect(res.status).toHaveBeenCalledWith(201);
    expect(res.json).toHaveBeenCalledWith({
      success: true,
      message: '团队创建成功',
      data: {
        id: '123',
        teamName: '测试团队',
        inviteCode: 'ABC123'
      }
    });
  });
  
  test('should handle service error properly', async () => {
    // 准备测试数据
    req.body = {
      name: '张三',
      phone: '13800000000'
    };
    
    // 配置模拟服务抛出异常
    mockTeamService.createTeamLeader.mockRejectedValue(new Error('领队手机号已被注册'));
    
    // 执行控制器方法
    await teamController.createTeamLeader(req, res);
    
    // 验证错误处理
    expect(res.status).toHaveBeenCalledWith(400);
    expect(res.json).toHaveBeenCalledWith({
      success: false,
      message: '领队手机号已被注册'
    });
  });
});
```

### 集成测试

集成测试将专注于测试各个领域组件之间的交互，以及API路由的正确性。

#### 数据库集成测试

测试服务与数据库的集成。

```javascript
// RegistrationService与数据库集成测试
describe('RegistrationService Integration', () => {
  let registrationService;
  let mongoServer;
  
  // 在所有测试之前启动内存数据库
  beforeAll(async () => {
    mongoServer = await MongoMemoryServer.create();
    const uri = mongoServer.getUri();
    await mongoose.connect(uri);
  });
  
  // 在所有测试之后关闭数据库连接
  afterAll(async () => {
    await mongoose.disconnect();
    await mongoServer.stop();
  });
  
  // 在每个测试之前清空数据库
  beforeEach(async () => {
    await mongoose.connection.db.dropDatabase();
    registrationService = new RegistrationService(new RegistrationRepository());
  });
  
  test('should create and retrieve registration', async () => {
    // 创建注册记录
    const registrationData = {
      teamName: '集成测试团队',
      leader: { name: '张三', phone: '13800000000' }
    };
    
    const created = await registrationService.createRegistration(registrationData);
    expect(created._id).toBeDefined();
    
    // 获取注册记录
    const retrieved = await registrationService.getRegistrationById(created._id);
    expect(retrieved).not.toBeNull();
    expect(retrieved.teamName).toBe('集成测试团队');
  });
  
  test('should prevent duplicate leader phone', async () => {
    // 创建第一个注册记录
    await registrationService.createRegistration({
      teamName: '团队1',
      leader: { name: '张三', phone: '13800000000' }
    });
    
    // 尝试创建具有相同领队手机号的记录
    await expect(
      registrationService.createRegistration({
        teamName: '团队2',
        leader: { name: '李四', phone: '13800000000' }
      })
    ).rejects.toThrow('领队手机号已被注册');
  });
});
```

#### API集成测试

测试API端点的正确性。

```javascript
// 注册API集成测试
describe('Registration API', () => {
  let app;
  let mongoServer;
  
  beforeAll(async () => {
    mongoServer = await MongoMemoryServer.create();
    const uri = mongoServer.getUri();
    // 配置应用使用测试数据库
    process.env.DB_URI = uri;
    // 引入应用
    app = require('../app');
  });
  
  afterAll(async () => {
    await mongoose.disconnect();
    await mongoServer.stop();
  });
  
  beforeEach(async () => {
    await mongoose.connection.db.dropDatabase();
  });
  
  test('POST /api/registration/team/leader should create team leader', async () => {
    const response = await request(app)
      .post('/api/registration/team/leader')
      .send({
        name: '张三',
        phone: '13800000000',
        teamName: 'API测试团队'
      });
    
    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
    expect(response.body.data.teamName).toBe('API测试团队');
    expect(response.body.data.inviteCode).toBeDefined();
  });
  
  test('POST /api/registration/team/join should join team', async () => {
    // 先创建团队
    const createResponse = await request(app)
      .post('/api/registration/team/leader')
      .send({
        name: '张三',
        phone: '13800000000',
        teamName: 'API测试团队'
      });
    
    const inviteCode = createResponse.body.data.inviteCode;
    
    // 加入团队
    const joinResponse = await request(app)
      .post('/api/registration/team/join')
      .send({
        name: '李四',
        phone: '13900000000',
        inviteCode
      });
    
    expect(joinResponse.status).toBe(200);
    expect(joinResponse.body.success).toBe(true);
    expect(joinResponse.body.data.memberName).toBe('李四');
  });
  
  test('GET /api/registration/team/:teamId/members should retrieve team members', async () => {
    // 先创建团队
    const createResponse = await request(app)
      .post('/api/registration/team/leader')
      .send({
        name: '张三',
        phone: '13800000000',
        teamName: 'API测试团队'
      });
    
    const teamId = createResponse.body.data.id;
    
    // 获取团队成员
    const membersResponse = await request(app)
      .get(`/api/registration/team/${teamId}/members`);
    
    expect(membersResponse.status).toBe(200);
    expect(membersResponse.body.success).toBe(true);
    expect(membersResponse.body.data.teamName).toBe('API测试团队');
    expect(membersResponse.body.data.members).toHaveLength(1);
    expect(membersResponse.body.data.members[0].name).toBe('张三');
    expect(membersResponse.body.data.members[0].isLeader).toBe(true);
  });
});
```

#### 跨领域集成测试

测试不同领域之间的交互。

```javascript
// 支付与注册领域集成测试
describe('Payment and Registration Integration', () => {
  let app;
  let mongoServer;
  let teamId;
  
  beforeAll(async () => {
    mongoServer = await MongoMemoryServer.create();
    const uri = mongoServer.getUri();
    process.env.DB_URI = uri;
    app = require('../app');
  });
  
  afterAll(async () => {
    await mongoose.disconnect();
    await mongoServer.stop();
  });
  
  beforeEach(async () => {
    await mongoose.connection.db.dropDatabase();
    
    // 创建一个团队用于测试
    const createResponse = await request(app)
      .post('/api/registration/team/leader')
      .send({
        name: '张三',
        phone: '13800000000',
        teamName: '集成测试团队'
      });
    
    teamId = createResponse.body.data.id;
  });
  
  test('Payment success should update registration payment status', async () => {
    // 创建支付订单
    const createPaymentResponse = await request(app)
      .post('/api/payment/create')
      .send({
        registrationId: teamId,
        amount: 100,
        paymentMethod: 'wechat'
      });
    
    expect(createPaymentResponse.status).toBe(200);
    const paymentId = createPaymentResponse.body.data.paymentId;
    
    // 模拟支付成功回调
    const notifyResponse = await request(app)
      .post('/api/payment/notify/wechat')
      .send({
        out_trade_no: paymentId,
        total_fee: 100,
        result_code: 'SUCCESS'
      });
    
    expect(notifyResponse.status).toBe(200);
    
    // 检查注册记录的支付状态是否更新
    const registrationResponse = await request(app)
      .get(`/api/registration/${teamId}`);
    
    expect(registrationResponse.status).toBe(200);
    expect(registrationResponse.body.data.paymentStatus).toBe('PAID');
    expect(registrationResponse.body.data.paidAmount).toBe(100);
    expect(registrationResponse.body.data.paidAt).toBeDefined();
  });
});
```

### 端到端测试

端到端测试将模拟真实用户的使用场景，测试完整的业务流程。

#### 用户场景测试

使用Cypress进行UI和API的端到端测试。

```javascript
// Cypress端到端测试示例
describe('Team Registration E2E', () => {
  it('should complete full team registration process', () => {
    // 访问报名页面
    cy.visit('/register');
    
    // 填写团队领队信息
    cy.get('#leader-name').type('张三');
    cy.get('#leader-phone').type('13800000000');
    cy.get('#team-name').type('端到端测试团队');
    cy.get('#submit-leader').click();
    
    // 确认成功并获取邀请码
    cy.get('.success-message').should('be.visible');
    cy.get('#invite-code').should('be.visible').then(($inviteCode) => {
      const inviteCode = $inviteCode.text();
      
      // 新成员使用邀请码加入团队
      cy.visit('/join');
      cy.get('#member-name').type('李四');
      cy.get('#member-phone').type('13900000000');
      cy.get('#invite-code').type(inviteCode);
      cy.get('#submit-join').click();
      
      // 确认加入成功
      cy.get('.success-message').should('be.visible');
      cy.get('.team-name').should('contain', '端到端测试团队');
      
      // 查看团队成员列表
      cy.visit(`/team/${inviteCode}`);
      cy.get('.team-name').should('contain', '端到端测试团队');
      cy.get('.team-members').should('have.length', 2);
      cy.get('.team-members').first().should('contain', '张三').and('contain', '队长');
      cy.get('.team-members').last().should('contain', '李四');
      
      // 支付流程
      cy.get('#pay-button').click();
      cy.get('#payment-amount').should('contain', '100');
      cy.get('#wechat-pay').click();
      
      // 模拟支付完成
      cy.window().then((win) => {
        win.mockPaymentSuccess();
      });
      
      // 确认支付成功
      cy.get('.payment-success').should('be.visible');
      cy.get('.payment-status').should('contain', '已支付');
    });
  });
});
```

#### 接口测试自动化

使用Postman和Newman进行API自动化测试。

```json
// Postman集合示例
{
  "info": {
    "name": "团队报名系统API测试",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "创建团队领队",
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/api/registration/team/leader",
        "body": {
          "mode": "raw",
          "raw": "{\"name\":\"张三\",\"phone\":\"13800000000\",\"teamName\":\"Postman测试团队\"}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        }
      },
      "response": []
    },
    {
      "name": "加入团队",
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/api/registration/team/join",
        "body": {
          "mode": "raw",
          "raw": "{\"name\":\"李四\",\"phone\":\"13900000000\",\"inviteCode\":\"{{inviteCode}}\"}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        }
      },
      "response": []
    },
    {
      "name": "获取团队成员",
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/api/registration/team/{{teamId}}/members"
      },
      "response": []
    }
  ]
}
```

## 测试自动化与CI/CD集成

### 持续集成流程

1. **代码提交触发测试**：
   - 开发人员提交代码到Git仓库
   - CI系统自动拉取代码并运行测试

2. **测试阶段**：
   - 静态代码分析（使用ESLint）
   - 运行单元测试
   - 运行集成测试
   - 运行端到端测试
   - 生成覆盖率报告

3. **构建和部署**：
   - 如果测试通过，构建Docker镜像
   - 部署到测试环境
   - 运行环境测试

### GitHub Actions示例

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Lint code
      run: npm run lint
      
    - name: Run unit tests
      run: npm run test:unit
      
    - name: Run integration tests
      run: npm run test:integration
      
    - name: Run e2e tests
      run: npm run test:e2e
      
    - name: Upload coverage report
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage/
```

## 测试实施计划

### 阶段1：单元测试实现（2周）

1. **准备工作**：
   - 配置Jest和测试环境
   - 创建测试目录结构
   - 设置代码覆盖率工具

2. **开发领域模型测试**：
   - 实现所有领域模型的单元测试
   - 验证业务规则和约束

3. **开发服务层测试**：
   - 实现所有领域服务的单元测试
   - 使用模拟对象隔离外部依赖

4. **开发控制器测试**：
   - 实现所有控制器的单元测试
   - 验证请求处理和错误处理

### 阶段2：集成测试实现（2周）

1. **准备工作**：
   - 配置测试数据库环境
   - 准备测试数据集

2. **开发数据库集成测试**：
   - 测试领域服务与数据库的集成
   - 验证持久化逻辑

3. **开发API集成测试**：
   - 测试API路由和端点功能
   - 验证请求参数处理和响应格式

4. **开发跨领域集成测试**：
   - 测试领域间的交互
   - 验证事件通知和状态更新

### 阶段3：端到端测试实现（1周）

1. **准备工作**：
   - 配置Cypress环境
   - 创建测试用例规范

2. **开发用户场景测试**：
   - 实现关键业务流程的端到端测试
   - 验证完整用户体验

3. **开发Postman测试集合**：
   - 创建API测试集合
   - 配置测试环境变量

### 阶段4：持续集成配置（1周）

1. **配置GitHub Actions**：
   - 设置自动化测试工作流
   - 配置测试环境变量

2. **设置测试结果报告**：
   - 配置测试结果展示
   - 设置覆盖率阈值和警报

3. **实施测试驱动开发流程**：
   - 创建拉取请求模板
   - 设置代码审查规则

## 结论

本测试计划为团队报名系统服务端提供了全面的自动化测试策略。通过实施这些测试，我们可以确保重构后的代码保持高质量，同时为未来的开发提供安全保障。测试将分四个阶段实施，总计需要6周时间完成。完成后，团队将拥有一个可靠的测试套件，支持持续集成和部署流程。 